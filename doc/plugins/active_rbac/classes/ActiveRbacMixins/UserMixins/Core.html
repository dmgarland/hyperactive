<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: ActiveRbacMixins::UserMixins::Core</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">ActiveRbacMixins::UserMixins::Core</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../files/home/yossarian/aptana_workspace/imcalendar/config/__/vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins_rb.html">
                /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000069">all_groups</a>&nbsp;&nbsp;
      <a href="#M000068">all_roles</a>&nbsp;&nbsp;
      <a href="#M000071">all_static_permissions</a>&nbsp;&nbsp;
      <a href="#M000062">before_create</a>&nbsp;&nbsp;
      <a href="#M000075">confirm_registration</a>&nbsp;&nbsp;
      <a href="#M000074">create_user_registration</a>&nbsp;&nbsp;
      <a href="#M000088">default_password_hash_types</a>&nbsp;&nbsp;
      <a href="#M000076">default_state</a>&nbsp;&nbsp;
      <a href="#M000087">default_states</a>&nbsp;&nbsp;
      <a href="#M000083">did_log_in</a>&nbsp;&nbsp;
      <a href="#M000067">encrypt_password</a>&nbsp;&nbsp;
      <a href="#M000085">execute_without_timestamps</a>&nbsp;&nbsp;
      <a href="#M000081">find_with_credentials</a>&nbsp;&nbsp;
      <a href="#M000072">has_permission?</a>&nbsp;&nbsp;
      <a href="#M000070">has_role?</a>&nbsp;&nbsp;
      <a href="#M000089">hash_string</a>&nbsp;&nbsp;
      <a href="#M000079">human_attribute_name</a>&nbsp;&nbsp;
      <a href="#M000058">included</a>&nbsp;&nbsp;
      <a href="#M000073">is_anonymous?</a>&nbsp;&nbsp;
      <a href="#M000061">new</a>&nbsp;&nbsp;
      <a href="#M000065">new_password?</a>&nbsp;&nbsp;
      <a href="#M000064">password=</a>&nbsp;&nbsp;
      <a href="#M000082">password_equals?</a>&nbsp;&nbsp;
      <a href="#M000063">password_hash_type=</a>&nbsp;&nbsp;
      <a href="#M000060">password_hash_types</a>&nbsp;&nbsp;
      <a href="#M000080">purge_users_with_expired_registration</a>&nbsp;&nbsp;
      <a href="#M000078">state=</a>&nbsp;&nbsp;
      <a href="#M000077">state_allows_login?</a>&nbsp;&nbsp;
      <a href="#M000084">state_transition_allowed?</a>&nbsp;&nbsp;
      <a href="#M000059">states</a>&nbsp;&nbsp;
      <a href="#M000066">update_password</a>&nbsp;&nbsp;
      <a href="#M000086">validate</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000088" class="method-detail">
        <a name="M000088"></a>

        <div class="method-heading">
          <a href="#M000088" class="method-signature">
          <span class="method-name">default_password_hash_types</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method returns an array which contains all valid hash types.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000088-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000088-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 425</span>
425:             <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">default_password_hash_types</span>
426:               [ <span class="ruby-value str">'md5'</span> ]
427:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000076" class="method-detail">
        <a name="M000076"></a>

        <div class="method-heading">
          <a href="#M000076" class="method-signature">
          <span class="method-name">default_state</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the default state of <a href="Core.html#M000061">new</a> <a
href="../../User.html">User</a> objects.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000076-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000076-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 258</span>
258:           <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">default_state</span>
259:             <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'unconfirmed'</span>]
260:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000087" class="method-detail">
        <a name="M000087"></a>

        <div class="method-heading">
          <a href="#M000087" class="method-signature">
          <span class="method-name">default_states</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method returns a hash which contains a mapping of user <a
href="Core.html#M000059">states</a> valid by default and their description.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000087-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000087-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 411</span>
411:             <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">default_states</span>
412:               {
413:                 <span class="ruby-value str">'unconfirmed'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,
414:                 <span class="ruby-value str">'confirmed'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>,
415:                 <span class="ruby-value str">'locked'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span>,
416:                 <span class="ruby-value str">'deleted'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">4</span>,
417:                 <span class="ruby-comment cmt"># The user has just retrieved his password and he must now</span>
418:                 <span class="ruby-comment cmt"># it. The user cannot anything in this state but change his</span>
419:                 <span class="ruby-comment cmt"># password after having logged in and retrieve another one.</span>
420:                 <span class="ruby-value str">'retrieved_password'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">5</span>
421:               }
422:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000085" class="method-detail">
        <a name="M000085"></a>

        <div class="method-heading">
          <a href="#M000085" class="method-signature">
          <span class="method-name">execute_without_timestamps</span><span class="method-args">() {|| ...}</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method allows to execute a block while deactivating timestamp
updating.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000085-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000085-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 370</span>
370:             <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">execute_without_timestamps</span>
371:               <span class="ruby-identifier">old_state</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">record_timestamps</span>
372:               <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">record_timestamps</span> = <span class="ruby-keyword kw">false</span>
373: 
374:               <span class="ruby-keyword kw">yield</span>
375: 
376:               <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">record_timestamps</span> = <span class="ruby-identifier">old_state</span>
377:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000081" class="method-detail">
        <a name="M000081"></a>

        <div class="method-heading">
          <a href="#M000081" class="method-signature">
          <span class="method-name">find_with_credentials</span><span class="method-args">(login, password)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This static method tries to find a user with the given login and password
in the database. Returns the user or nil if he could not be found
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000081-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000081-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 296</span>
296:           <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_with_credentials</span>(<span class="ruby-identifier">login</span>, <span class="ruby-identifier">password</span>)
297:             <span class="ruby-comment cmt"># Find user</span>
298:             <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:first</span>,
299:                              <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [ <span class="ruby-value str">'login = ?'</span>, <span class="ruby-identifier">login</span> ]
300: 
301:             <span class="ruby-comment cmt"># If the user could be found and the passwords equal then return the user</span>
302:             <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">password_equals?</span> <span class="ruby-identifier">password</span>
303:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">login_failure_count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
304:                 <span class="ruby-identifier">user</span>.<span class="ruby-identifier">login_failure_count</span> = <span class="ruby-value">0</span>
305:                 <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">execute_without_timestamps</span> { <span class="ruby-identifier">user</span>.<span class="ruby-identifier">save!</span> }
306:               <span class="ruby-keyword kw">end</span>
307: 
308:               <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">user</span>
309:             <span class="ruby-keyword kw">end</span>
310: 
311:             <span class="ruby-comment cmt"># Otherwise increase the login count - if the user could be found - and return nil</span>
312:             <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">nil?</span>
313:               <span class="ruby-identifier">user</span>.<span class="ruby-identifier">login_failure_count</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">login_failure_count</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
314:               <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">execute_without_timestamps</span> { <span class="ruby-identifier">user</span>.<span class="ruby-identifier">save!</span> }
315:             <span class="ruby-keyword kw">end</span>
316: 
317:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
318:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000079" class="method-detail">
        <a name="M000079"></a>

        <div class="method-heading">
          <a href="#M000079" class="method-signature">
          <span class="method-name">human_attribute_name</span><span class="method-args">(attr)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Overriding this method to make &quot;login&quot; visible as &quot;<a
href="../../User.html">User</a> name&quot;. This is called in forms to
create error messages.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000079-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000079-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 277</span>
277:           <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">human_attribute_name</span> (<span class="ruby-identifier">attr</span>)
278:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">attr</span>
279:                    <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'login'</span> <span class="ruby-keyword kw">then</span> <span class="ruby-value str">'User name'</span>
280:                    <span class="ruby-keyword kw">else</span> <span class="ruby-identifier">attr</span>.<span class="ruby-identifier">humanize</span>
281:                    <span class="ruby-keyword kw">end</span>
282:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000058" class="method-detail">
        <a name="M000058"></a>

        <div class="method-heading">
          <a href="#M000058" class="method-signature">
          <span class="method-name">included</span><span class="method-args">(base)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method is called when the module is <a
href="Core.html#M000058">included</a>.
</p>
<p>
On inclusion, we do a nifty bit of meta programming and make the including
class behave like ActiveRBAC&#8216;s <a href="../../User.html">User</a>
class without some of the validation. Extensive validation can be done by
including the <a href="Validation.html">Validation</a> class.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000058-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000058-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 27</span>
 27:       <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">included</span>(<span class="ruby-identifier">base</span>)
 28:         <span class="ruby-identifier">base</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-keyword kw">do</span>
 29:           <span class="ruby-comment cmt"># users have a n:m relation to group</span>
 30:           <span class="ruby-identifier">has_and_belongs_to_many</span> <span class="ruby-identifier">:groups</span>, <span class="ruby-identifier">:uniq</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
 31:           <span class="ruby-comment cmt"># users have a n:m relation to roles</span>
 32:           <span class="ruby-identifier">has_and_belongs_to_many</span> <span class="ruby-identifier">:roles</span>, <span class="ruby-identifier">:uniq</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
 33:           <span class="ruby-comment cmt"># users have 0..1 user_registration records assigned to them</span>
 34:           <span class="ruby-identifier">has_one</span> <span class="ruby-identifier">:user_registration</span>
 35: 
 36:           <span class="ruby-comment cmt"># We don't want to assign things to roles and groups in bulk assigns.</span>
 37:           <span class="ruby-identifier">attr_protected</span> <span class="ruby-identifier">:roles</span>, <span class="ruby-identifier">:groups</span>, <span class="ruby-identifier">:created_at</span>, <span class="ruby-identifier">:updated_at</span>, <span class="ruby-identifier">:last_logged_in_at</span>, <span class="ruby-identifier">:login_failure_count</span>, <span class="ruby-identifier">:password_hash_type</span>
 38: 
 39:           <span class="ruby-comment cmt"># This method returns a hash with the the available user states. </span>
 40:           <span class="ruby-comment cmt"># By default it returns the private class constant DEFAULT_STATES.</span>
 41:           <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">states</span>
 42:             <span class="ruby-identifier">default_states</span>
 43:           <span class="ruby-keyword kw">end</span>
 44: 
 45:           <span class="ruby-comment cmt"># This method returns an array with the names of all available</span>
 46:           <span class="ruby-comment cmt"># password hash types supported by this User class.</span>
 47:           <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password_hash_types</span>
 48:             <span class="ruby-identifier">default_password_hash_types</span>
 49:           <span class="ruby-keyword kw">end</span>
 50: 
 51:           <span class="ruby-comment cmt"># When a record object is initialized, we set the state, password</span>
 52:           <span class="ruby-comment cmt"># hash type, indicator whether the password has freshly been set </span>
 53:           <span class="ruby-comment cmt"># (@new_password) and the login failure count to </span>
 54:           <span class="ruby-comment cmt"># unconfirmed/false/0 when it has not been set yet.</span>
 55:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span> (<span class="ruby-identifier">attributes</span> = <span class="ruby-keyword kw">nil</span>)
 56:             <span class="ruby-keyword kw">super</span>(<span class="ruby-identifier">attributes</span>)
 57: 
 58:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">state</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'unconfirmed'</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">state</span>.<span class="ruby-identifier">nil?</span> 
 59:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password_hash_type</span> = <span class="ruby-value str">'md5'</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password_hash_type</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-value str">''</span>
 60: 
 61:             <span class="ruby-ivar">@new_password</span> = <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@new_password</span>.<span class="ruby-identifier">nil?</span>
 62:             <span class="ruby-ivar">@new_hash_type</span> = <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@new_hash_type</span>.<span class="ruby-identifier">nil?</span>
 63: 
 64:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">login_failure_count</span> = <span class="ruby-value">0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">login_failure_count</span>.<span class="ruby-identifier">nil?</span>
 65:           <span class="ruby-keyword kw">end</span>
 66: 
 67:           <span class="ruby-comment cmt"># Set the last login time etc. when the record is created at first.</span>
 68:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">before_create</span>
 69:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">last_logged_in_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
 70:           <span class="ruby-keyword kw">end</span>
 71: 
 72:           <span class="ruby-comment cmt"># Override the accessor for the &quot;password_hash_type&quot; property so it sets</span>
 73:           <span class="ruby-comment cmt"># the &quot;@new_hash_type&quot; private property to signal that the password's</span>
 74:           <span class="ruby-comment cmt"># hash method has been changed. Changing the password hash type is only</span>
 75:           <span class="ruby-comment cmt"># possible if a new password has been provided.</span>
 76:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">password_hash_type=</span>(<span class="ruby-identifier">value</span>)
 77:             <span class="ruby-identifier">write_attribute</span>(<span class="ruby-identifier">:password_hash_type</span>, <span class="ruby-identifier">value</span>)
 78:             <span class="ruby-ivar">@new_hash_type</span> = <span class="ruby-keyword kw">true</span>
 79:           <span class="ruby-keyword kw">end</span>
 80: 
 81:           <span class="ruby-comment cmt"># After saving, we want to set the &quot;@new_hash_type&quot; value set to false</span>
 82:           <span class="ruby-comment cmt"># again.</span>
 83:           <span class="ruby-identifier">after_save</span> <span class="ruby-value str">'@new_hash_type = false'</span>
 84: 
 85:           <span class="ruby-comment cmt"># Add accessors for &quot;new_password&quot; property. This boolean property is set </span>
 86:           <span class="ruby-comment cmt"># to true when the password has been set and validation on this password is</span>
 87:           <span class="ruby-comment cmt"># required.</span>
 88:           <span class="ruby-identifier">attr_accessor</span> <span class="ruby-identifier">:new_password</span>
 89: 
 90:           <span class="ruby-comment cmt"># Generate accessors for the password confirmation property.</span>
 91:           <span class="ruby-identifier">attr_accessor</span> <span class="ruby-identifier">:password_confirmation</span>
 92: 
 93:           <span class="ruby-comment cmt"># Overriding the default accessor to update @new_password on setting this</span>
 94:           <span class="ruby-comment cmt"># property.</span>
 95:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">password=</span>(<span class="ruby-identifier">value</span>)
 96:             <span class="ruby-identifier">write_attribute</span>(<span class="ruby-identifier">:password</span>, <span class="ruby-identifier">value</span>)
 97:             <span class="ruby-ivar">@new_password</span> = <span class="ruby-keyword kw">true</span>
 98:           <span class="ruby-keyword kw">end</span>
 99:           
100:           <span class="ruby-comment cmt"># Returns true if the password has been set after the User has been loaded</span>
101:           <span class="ruby-comment cmt"># from the database and false otherwise</span>
102:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">new_password?</span>
103:             <span class="ruby-ivar">@new_password</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">true</span>
104:           <span class="ruby-keyword kw">end</span>
105: 
106:           <span class="ruby-comment cmt"># Method to update the password and confirmation at the same time. Call</span>
107:           <span class="ruby-comment cmt"># this method when you update the password from code and don't need </span>
108:           <span class="ruby-comment cmt"># password_confirmation - which should really only be used when data</span>
109:           <span class="ruby-comment cmt"># comes from forms. </span>
110:           <span class="ruby-comment cmt">#</span>
111:           <span class="ruby-comment cmt"># A ussage example:</span>
112:           <span class="ruby-comment cmt">#</span>
113:           <span class="ruby-comment cmt">#   user = User.find(1)</span>
114:           <span class="ruby-comment cmt">#   user.update_password &quot;n1C3s3cUreP4sSw0rD&quot;</span>
115:           <span class="ruby-comment cmt">#   user.save</span>
116:           <span class="ruby-comment cmt">#</span>
117:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_password</span>(<span class="ruby-identifier">pass</span>)
118:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password_confirmation</span> = <span class="ruby-identifier">pass</span>
119:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password</span> = <span class="ruby-identifier">pass</span>
120:           <span class="ruby-keyword kw">end</span>
121: 
122:           <span class="ruby-comment cmt"># After saving the object into the database, the password is not new any more.</span>
123:           <span class="ruby-identifier">after_save</span> <span class="ruby-value str">'@new_password = false'</span>
124: 
125:           <span class="ruby-comment cmt"># This method writes the attribute &quot;password&quot; to the hashed version. It is </span>
126:           <span class="ruby-comment cmt"># called in the after_validation hook set by the &quot;after_validation&quot; command</span>
127:           <span class="ruby-comment cmt"># above.</span>
128:           <span class="ruby-comment cmt"># The password is only encrypted when no errors occured on validation, the</span>
129:           <span class="ruby-comment cmt"># password is new and the password is not nil.</span>
130:           <span class="ruby-comment cmt"># This method also sets the &quot;password_salt&quot; property's value used in </span>
131:           <span class="ruby-comment cmt"># User#hash_string.</span>
132:           <span class="ruby-comment cmt"># After encryption, the password's &quot;new&quot; state is reset and the confirmation</span>
133:           <span class="ruby-comment cmt"># is cleared. The password hash's type will also be set to &quot;not new&quot; since</span>
134:           <span class="ruby-comment cmt"># we get problems with double validation (as it happens when using save!)</span>
135:           <span class="ruby-comment cmt"># otherwise.</span>
136:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">encrypt_password</span>
137:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">and</span> <span class="ruby-ivar">@new_password</span> <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">password</span>.<span class="ruby-identifier">nil?</span>
138:               <span class="ruby-comment cmt"># generate a new 10-char long hash only Base64 encoded so things are compatible</span>
139:               <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password_salt</span> = [<span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">10</span>){<span class="ruby-identifier">rand</span>(<span class="ruby-value">256</span>).<span class="ruby-identifier">chr</span>}.<span class="ruby-identifier">join</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">&quot;m&quot;</span>)[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">9</span>]; 
140: 
141:               <span class="ruby-comment cmt"># write encrypted password to object property</span>
142:               <span class="ruby-identifier">write_attribute</span>(<span class="ruby-identifier">:password</span>, <span class="ruby-identifier">hash_string</span>(<span class="ruby-identifier">password</span>))
143: 
144:               <span class="ruby-comment cmt"># mark password as &quot;not new&quot; any more</span>
145:               <span class="ruby-ivar">@new_password</span> = <span class="ruby-keyword kw">false</span>
146:               <span class="ruby-identifier">password_confirmation</span> = <span class="ruby-keyword kw">nil</span>
147:               
148:               <span class="ruby-comment cmt"># mark the hash type as &quot;not new&quot; any more</span>
149:               <span class="ruby-ivar">@new_hash_type</span> = <span class="ruby-keyword kw">false</span>
150:             <span class="ruby-keyword kw">end</span>
151:           <span class="ruby-keyword kw">end</span>
152: 
153:           <span class="ruby-comment cmt"># This method returns all roles assigned to the given user - including</span>
154:           <span class="ruby-comment cmt"># the ones he gets by being assigned a child role (i.e. the parents)</span>
155:           <span class="ruby-comment cmt"># and the one he gets through his groups (inheritance is also considered)</span>
156:           <span class="ruby-comment cmt"># here.</span>
157:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">all_roles</span>
158:             <span class="ruby-identifier">result</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
159: 
160:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">role</span> <span class="ruby-keyword kw">in</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">roles</span>
161:               <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">role</span>.<span class="ruby-identifier">ancestors_and_self</span>
162:             <span class="ruby-keyword kw">end</span>
163: 
164:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">group</span> <span class="ruby-keyword kw">in</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">groups</span>
165:               <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">group</span>.<span class="ruby-identifier">all_roles</span>
166:             <span class="ruby-keyword kw">end</span>
167: 
168:             <span class="ruby-identifier">result</span>.<span class="ruby-identifier">flatten!</span>
169:             <span class="ruby-identifier">result</span>.<span class="ruby-identifier">uniq!</span>
170: 
171:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">result</span>
172:           <span class="ruby-keyword kw">end</span>
173: 
174:           <span class="ruby-comment cmt"># This method returns all groups assigned to the given user - including</span>
175:           <span class="ruby-comment cmt"># the ones he gets by being assigned through group inheritance.</span>
176:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">all_groups</span>
177:             <span class="ruby-identifier">result</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
178: 
179:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">group</span> <span class="ruby-keyword kw">in</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">groups</span>
180:               <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">group</span>.<span class="ruby-identifier">ancestors_and_self</span>
181:             <span class="ruby-keyword kw">end</span>
182: 
183:             <span class="ruby-identifier">result</span>.<span class="ruby-identifier">flatten!</span>
184:             <span class="ruby-identifier">result</span>.<span class="ruby-identifier">uniq!</span>
185: 
186:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">result</span>
187:           <span class="ruby-keyword kw">end</span>
188: 
189:           <span class="ruby-comment cmt"># This method returns true if the user is assigned the role with one of the</span>
190:           <span class="ruby-comment cmt"># role titles given as parameters. False otherwise.</span>
191:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_role?</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">role_titles</span>)
192:             <span class="ruby-identifier">obj</span> = <span class="ruby-identifier">all_roles</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">role</span><span class="ruby-operator">|</span> 
193:                     <span class="ruby-identifier">role_titles</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">role</span>.<span class="ruby-identifier">title</span>)
194:                   <span class="ruby-keyword kw">end</span>
195:             
196:             <span class="ruby-keyword kw">return</span> <span class="ruby-operator">!</span><span class="ruby-identifier">obj</span>.<span class="ruby-identifier">nil?</span>
197:           <span class="ruby-keyword kw">end</span>
198: 
199:           <span class="ruby-comment cmt"># This method returns a list of all the StaticPermission entities that</span>
200:           <span class="ruby-comment cmt"># have been assigned to this user through his roles.</span>
201:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">all_static_permissions</span>
202:             <span class="ruby-identifier">permissions</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
203: 
204:             <span class="ruby-identifier">all_roles</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">role</span><span class="ruby-operator">|</span>
205:               <span class="ruby-identifier">permissions</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">role</span>.<span class="ruby-identifier">static_permissions</span>)
206:             <span class="ruby-keyword kw">end</span>
207: 
208:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">permissions</span>
209:           <span class="ruby-keyword kw">end</span>
210: 
211:           <span class="ruby-comment cmt"># This method returns true if the user is granted the permission with one</span>
212:           <span class="ruby-comment cmt"># of the given permission titles.</span>
213:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_permission?</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">permission_titles</span>)
214:             <span class="ruby-identifier">all_roles</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">role</span><span class="ruby-operator">|</span> 
215:               <span class="ruby-identifier">role</span>.<span class="ruby-identifier">static_permissions</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">permission</span><span class="ruby-operator">|</span>
216:                 <span class="ruby-identifier">permission_titles</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">permission</span>.<span class="ruby-identifier">title</span>)
217:               <span class="ruby-keyword kw">end</span>
218:             <span class="ruby-keyword kw">end</span>
219:           <span class="ruby-keyword kw">end</span>
220:           
221:           <span class="ruby-comment cmt"># Returns false. is_anonymous? will only return true on AnonymousUser</span>
222:           <span class="ruby-comment cmt"># objects.</span>
223:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">is_anonymous?</span>
224:             <span class="ruby-keyword kw">false</span>
225:           <span class="ruby-keyword kw">end</span>
226:           
227: 
228:           <span class="ruby-comment cmt"># This method creates a new registration token for the current user. Raises </span>
229:           <span class="ruby-comment cmt"># a MultipleRegistrationTokens Exception if the user already has a </span>
230:           <span class="ruby-comment cmt"># registration token assigned to him.</span>
231:           <span class="ruby-comment cmt">#</span>
232:           <span class="ruby-comment cmt"># Use this method instead of creating user_registration objects directly!</span>
233:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_user_registration</span>
234:             <span class="ruby-identifier">raise</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">user_registration</span>.<span class="ruby-identifier">nil?</span>
235: 
236:             <span class="ruby-identifier">token</span> = <span class="ruby-constant">UserRegistration</span>.<span class="ruby-identifier">new</span>
237:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">user_registration</span> = <span class="ruby-identifier">token</span>
238:           <span class="ruby-keyword kw">end</span>
239: 
240:           <span class="ruby-comment cmt"># This method expects the token for the current user. If the token is</span>
241:           <span class="ruby-comment cmt"># correct, the user's state will be set to &quot;confirmed&quot; and the associated</span>
242:           <span class="ruby-comment cmt"># &quot;user_registration&quot; record will be removed.</span>
243:           <span class="ruby-comment cmt"># Returns &quot;true&quot; on success and &quot;false&quot; on failure/or the user is already</span>
244:           <span class="ruby-comment cmt"># confirmed and/or has no &quot;user_registration&quot; record.</span>
245:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">confirm_registration</span>(<span class="ruby-identifier">token</span>)
246:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">user_registration</span>.<span class="ruby-identifier">nil?</span>
247:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">user_registration</span>.<span class="ruby-identifier">token</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">token</span>
248:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">state_transition_allowed?</span>(<span class="ruby-identifier">state</span>, <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'confirmed'</span>])
249: 
250:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">state</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'confirmed'</span>]
251:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">save!</span>
252:             <span class="ruby-identifier">user_registration</span>.<span class="ruby-identifier">destroy</span>
253: 
254:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
255:           <span class="ruby-keyword kw">end</span>
256: 
257:           <span class="ruby-comment cmt"># Returns the default state of new User objects.</span>
258:           <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">default_state</span>
259:             <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'unconfirmed'</span>]
260:           <span class="ruby-keyword kw">end</span>
261: 
262:           <span class="ruby-comment cmt"># Returns true when users with the given state may log in. False otherwise.</span>
263:           <span class="ruby-comment cmt"># The given parameter must be an integer.</span>
264:           <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">state_allows_login?</span>(<span class="ruby-identifier">state</span>)
265:             [ <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'confirmed'</span>], <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'retrieved_password'</span>] ].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">state</span>)
266:           <span class="ruby-keyword kw">end</span>
267: 
268:           <span class="ruby-comment cmt"># Overwrite the state setting so it backs up the initial state from</span>
269:           <span class="ruby-comment cmt"># the database.</span>
270:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">state=</span>(<span class="ruby-identifier">value</span>)
271:             <span class="ruby-ivar">@old_state</span> = <span class="ruby-identifier">state</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_state</span>.<span class="ruby-identifier">nil?</span>
272:             <span class="ruby-identifier">write_attribute</span>(<span class="ruby-identifier">:state</span>, <span class="ruby-identifier">value</span>)
273:           <span class="ruby-keyword kw">end</span>
274: 
275:           <span class="ruby-comment cmt"># Overriding this method to make &quot;login&quot; visible as &quot;User name&quot;. This is called in</span>
276:           <span class="ruby-comment cmt"># forms to create error messages.</span>
277:           <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">human_attribute_name</span> (<span class="ruby-identifier">attr</span>)
278:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">attr</span>
279:                    <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'login'</span> <span class="ruby-keyword kw">then</span> <span class="ruby-value str">'User name'</span>
280:                    <span class="ruby-keyword kw">else</span> <span class="ruby-identifier">attr</span>.<span class="ruby-identifier">humanize</span>
281:                    <span class="ruby-keyword kw">end</span>
282:           <span class="ruby-keyword kw">end</span>
283: 
284:           <span class="ruby-comment cmt"># This static method removes all users with state &quot;unconfirmed&quot; and expired</span>
285:           <span class="ruby-comment cmt"># registration tokens.</span>
286:           <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">purge_users_with_expired_registration</span>
287:             <span class="ruby-identifier">registrations</span> = <span class="ruby-constant">UserRegistration</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>,
288:                                                   <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [ <span class="ruby-value str">'expires_at &lt; ?'</span>, <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">ago</span>(<span class="ruby-value">2</span>.<span class="ruby-identifier">days</span>) ]
289:             <span class="ruby-identifier">registrations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">registration</span><span class="ruby-operator">|</span>
290:               <span class="ruby-identifier">registration</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">destroy</span>
291:             <span class="ruby-keyword kw">end</span>
292:           <span class="ruby-keyword kw">end</span>
293: 
294:           <span class="ruby-comment cmt"># This static method tries to find a user with the given login and password</span>
295:           <span class="ruby-comment cmt"># in the database. Returns the user or nil if he could not be found</span>
296:           <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_with_credentials</span>(<span class="ruby-identifier">login</span>, <span class="ruby-identifier">password</span>)
297:             <span class="ruby-comment cmt"># Find user</span>
298:             <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:first</span>,
299:                              <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [ <span class="ruby-value str">'login = ?'</span>, <span class="ruby-identifier">login</span> ]
300: 
301:             <span class="ruby-comment cmt"># If the user could be found and the passwords equal then return the user</span>
302:             <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">password_equals?</span> <span class="ruby-identifier">password</span>
303:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">login_failure_count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
304:                 <span class="ruby-identifier">user</span>.<span class="ruby-identifier">login_failure_count</span> = <span class="ruby-value">0</span>
305:                 <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">execute_without_timestamps</span> { <span class="ruby-identifier">user</span>.<span class="ruby-identifier">save!</span> }
306:               <span class="ruby-keyword kw">end</span>
307: 
308:               <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">user</span>
309:             <span class="ruby-keyword kw">end</span>
310: 
311:             <span class="ruby-comment cmt"># Otherwise increase the login count - if the user could be found - and return nil</span>
312:             <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">nil?</span>
313:               <span class="ruby-identifier">user</span>.<span class="ruby-identifier">login_failure_count</span> = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">login_failure_count</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
314:               <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">execute_without_timestamps</span> { <span class="ruby-identifier">user</span>.<span class="ruby-identifier">save!</span> }
315:             <span class="ruby-keyword kw">end</span>
316: 
317:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
318:           <span class="ruby-keyword kw">end</span>
319: 
320:           <span class="ruby-comment cmt"># This method checks whether the given value equals the password when</span>
321:           <span class="ruby-comment cmt"># hashed with this user's password hash type. Returns a boolean.</span>
322:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">password_equals?</span>(<span class="ruby-identifier">value</span>)
323:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">hash_string</span>(<span class="ruby-identifier">value</span>) <span class="ruby-operator">==</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password</span>
324:           <span class="ruby-keyword kw">end</span>
325: 
326:           <span class="ruby-comment cmt"># Sets the last login time and saves the object. Note: Must currently be </span>
327:           <span class="ruby-comment cmt"># called explicitely!</span>
328:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">did_log_in</span>
329:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">last_logged_in_at</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">now</span>
330:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">execute_without_timestamps</span> { <span class="ruby-identifier">save</span> }
331:           <span class="ruby-keyword kw">end</span>
332: 
333:           <span class="ruby-comment cmt"># Returns true if the the state transition from &quot;from&quot; state to &quot;to&quot; state </span>
334:           <span class="ruby-comment cmt"># is valid. Returns false otherwise. +new_state+ must be the integer value </span>
335:           <span class="ruby-comment cmt"># of the state as returned by +User.states['state_name']+.</span>
336:           <span class="ruby-comment cmt">#</span>
337:           <span class="ruby-comment cmt"># Note that currently no permission checking is included here; It does not </span>
338:           <span class="ruby-comment cmt"># matter what permissions the currently logged in user has, only that the</span>
339:           <span class="ruby-comment cmt"># state transition is legal in principle.</span>
340:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">state_transition_allowed?</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>)
341:             <span class="ruby-identifier">from</span> = <span class="ruby-identifier">from</span>.<span class="ruby-identifier">to_i</span>
342:             <span class="ruby-identifier">to</span> = <span class="ruby-identifier">to</span>.<span class="ruby-identifier">to_i</span>
343: 
344:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">from</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">to</span> <span class="ruby-comment cmt"># allow keeping state</span>
345: 
346:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">from</span>
347:               <span class="ruby-keyword kw">when</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'unconfirmed'</span>]
348:                 <span class="ruby-keyword kw">true</span>
349:               <span class="ruby-keyword kw">when</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'confirmed'</span>]
350:                 [ <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'retrieved_password'</span>], <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'locked'</span>], <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'deleted'</span>] ].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to</span>)
351:               <span class="ruby-keyword kw">when</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'locked'</span>]
352:                 [ <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'confirmed'</span>], <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'deleted'</span>] ].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to</span>)
353:               <span class="ruby-keyword kw">when</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'deleted'</span>]
354:                 [ <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'confirmed'</span>] ].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to</span>)
355:               <span class="ruby-keyword kw">when</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'retrieved_password'</span>]
356:                 [ <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'confirmed'</span>], <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'locked'</span>], <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'deleted'</span>] ].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to</span>)
357:               <span class="ruby-keyword kw">when</span> <span class="ruby-value">0</span>
358:                 <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>.<span class="ruby-identifier">value?</span>(<span class="ruby-identifier">to</span>)
359:               <span class="ruby-keyword kw">else</span>
360:                 <span class="ruby-keyword kw">false</span>
361:             <span class="ruby-keyword kw">end</span>
362:           <span class="ruby-keyword kw">end</span>
363: 
364:           <span class="ruby-comment cmt"># After validation, the password should be encrypted  </span>
365:           <span class="ruby-identifier">after_validation</span> <span class="ruby-identifier">:encrypt_password</span>
366: 
367:           <span class="ruby-identifier">protected</span>
368:             <span class="ruby-comment cmt"># This method allows to execute a block while deactivating timestamp</span>
369:             <span class="ruby-comment cmt"># updating.</span>
370:             <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">execute_without_timestamps</span>
371:               <span class="ruby-identifier">old_state</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">record_timestamps</span>
372:               <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">record_timestamps</span> = <span class="ruby-keyword kw">false</span>
373: 
374:               <span class="ruby-keyword kw">yield</span>
375: 
376:               <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">record_timestamps</span> = <span class="ruby-identifier">old_state</span>
377:             <span class="ruby-keyword kw">end</span>
378: 
379:             <span class="ruby-comment cmt"># Model Validation</span>
380: 
381:             <span class="ruby-identifier">validates_presence_of</span>   <span class="ruby-identifier">:login</span>, <span class="ruby-identifier">:email</span>, <span class="ruby-identifier">:password</span>, <span class="ruby-identifier">:password_hash_type</span>, <span class="ruby-identifier">:state</span>,
382:                                     <span class="ruby-identifier">:message</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'must be given'</span>
383: 
384:             <span class="ruby-identifier">validates_uniqueness_of</span> <span class="ruby-identifier">:login</span>, 
385:                                     <span class="ruby-identifier">:message</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'is the name of an already existing user.'</span>
386: 
387:             <span class="ruby-comment cmt"># Overriding this method to do some more validation: Password equals </span>
388:             <span class="ruby-comment cmt"># password_confirmation, state an password hash type being in the range</span>
389:             <span class="ruby-comment cmt"># of allowed values.</span>
390:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">validate</span>
391:               <span class="ruby-comment cmt"># validate state and password has type to be in the valid range of values</span>
392:               <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">:password_hash_type</span>, <span class="ruby-value str">&quot;must be in the list of hash types.&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">password_hash_types</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">password_hash_type</span>
393:               <span class="ruby-comment cmt"># check that the state transition is valid</span>
394:               <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">:state</span>, <span class="ruby-value str">&quot;must be a valid new state from the current state.&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">state_transition_allowed?</span>(<span class="ruby-ivar">@old_state</span>, <span class="ruby-identifier">state</span>)
395: 
396:               <span class="ruby-comment cmt"># validate the password</span>
397:               <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@new_password</span> <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">password</span>.<span class="ruby-identifier">nil?</span>
398:                 <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">:password</span>, <span class="ruby-value str">'must match the confirmation.'</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">password_confirmation</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">password</span>
399:               <span class="ruby-keyword kw">end</span>
400: 
401:               <span class="ruby-comment cmt"># check that the password hash type has not been set if no new password</span>
402:               <span class="ruby-comment cmt"># has been provided</span>
403:               <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@new_hash_type</span> <span class="ruby-keyword kw">and</span> (<span class="ruby-operator">!</span><span class="ruby-ivar">@new_password</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">password</span>.<span class="ruby-identifier">nil?</span>) <span class="ruby-keyword kw">then</span>
404:                 <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">:password_hash_type</span>, <span class="ruby-value str">'cannot be changed unless a new password has been provided.'</span>)
405:               <span class="ruby-keyword kw">end</span>
406:             <span class="ruby-keyword kw">end</span>
407: 
408:           <span class="ruby-identifier">private</span>
409:             <span class="ruby-comment cmt"># This method returns a hash which contains a mapping of user states </span>
410:             <span class="ruby-comment cmt"># valid by default and their description.</span>
411:             <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">default_states</span>
412:               {
413:                 <span class="ruby-value str">'unconfirmed'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,
414:                 <span class="ruby-value str">'confirmed'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>,
415:                 <span class="ruby-value str">'locked'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span>,
416:                 <span class="ruby-value str">'deleted'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">4</span>,
417:                 <span class="ruby-comment cmt"># The user has just retrieved his password and he must now</span>
418:                 <span class="ruby-comment cmt"># it. The user cannot anything in this state but change his</span>
419:                 <span class="ruby-comment cmt"># password after having logged in and retrieve another one.</span>
420:                 <span class="ruby-value str">'retrieved_password'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">5</span>
421:               }
422:             <span class="ruby-keyword kw">end</span>
423: 
424:             <span class="ruby-comment cmt"># This method returns an array which contains all valid hash types.</span>
425:             <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">default_password_hash_types</span>
426:               [ <span class="ruby-value str">'md5'</span> ]
427:             <span class="ruby-keyword kw">end</span>
428: 
429:             <span class="ruby-comment cmt"># Hashes the given parameter by the selected hashing method. It uses the</span>
430:             <span class="ruby-comment cmt"># &quot;password_salt&quot; property's value to make the hashing more secure.</span>
431:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">hash_string</span>(<span class="ruby-identifier">value</span>)
432:               <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">password_hash_type</span>
433:                      <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'md5'</span> <span class="ruby-keyword kw">then</span> <span class="ruby-constant">Digest</span><span class="ruby-operator">::</span><span class="ruby-constant">MD5</span>.<span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">value</span> <span class="ruby-operator">+</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password_salt</span>)
434:                      <span class="ruby-keyword kw">end</span>
435:             <span class="ruby-keyword kw">end</span> 
436:         <span class="ruby-keyword kw">end</span>
437:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000061" class="method-detail">
        <a name="M000061"></a>

        <div class="method-heading">
          <a href="#M000061" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(attributes = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
When a record object is initialized, we set the state, password hash type,
indicator whether the password has freshly been set (@new_password) and the
login failure count to unconfirmed/false/0 when it has not been set yet.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000061-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000061-source">
<pre>
    <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 55</span>
55:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span> (<span class="ruby-identifier">attributes</span> = <span class="ruby-keyword kw">nil</span>)
56:             <span class="ruby-keyword kw">super</span>(<span class="ruby-identifier">attributes</span>)
57: 
58:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">state</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'unconfirmed'</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">state</span>.<span class="ruby-identifier">nil?</span> 
59:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password_hash_type</span> = <span class="ruby-value str">'md5'</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password_hash_type</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-value str">''</span>
60: 
61:             <span class="ruby-ivar">@new_password</span> = <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@new_password</span>.<span class="ruby-identifier">nil?</span>
62:             <span class="ruby-ivar">@new_hash_type</span> = <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@new_hash_type</span>.<span class="ruby-identifier">nil?</span>
63: 
64:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">login_failure_count</span> = <span class="ruby-value">0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">login_failure_count</span>.<span class="ruby-identifier">nil?</span>
65:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000060" class="method-detail">
        <a name="M000060"></a>

        <div class="method-heading">
          <a href="#M000060" class="method-signature">
          <span class="method-name">password_hash_types</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method returns an array with the names of all available password hash
types supported by this <a href="../../User.html">User</a> class.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000060-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000060-source">
<pre>
    <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 47</span>
47:           <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password_hash_types</span>
48:             <span class="ruby-identifier">default_password_hash_types</span>
49:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000080" class="method-detail">
        <a name="M000080"></a>

        <div class="method-heading">
          <a href="#M000080" class="method-signature">
          <span class="method-name">purge_users_with_expired_registration</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This static method removes all users with state &quot;unconfirmed&quot; and
expired registration tokens.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000080-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000080-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 286</span>
286:           <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">purge_users_with_expired_registration</span>
287:             <span class="ruby-identifier">registrations</span> = <span class="ruby-constant">UserRegistration</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>,
288:                                                   <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [ <span class="ruby-value str">'expires_at &lt; ?'</span>, <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">ago</span>(<span class="ruby-value">2</span>.<span class="ruby-identifier">days</span>) ]
289:             <span class="ruby-identifier">registrations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">registration</span><span class="ruby-operator">|</span>
290:               <span class="ruby-identifier">registration</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">destroy</span>
291:             <span class="ruby-keyword kw">end</span>
292:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000077" class="method-detail">
        <a name="M000077"></a>

        <div class="method-heading">
          <a href="#M000077" class="method-signature">
          <span class="method-name">state_allows_login?</span><span class="method-args">(state)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns true when users with the given state may log in. False otherwise.
The given parameter must be an integer.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000077-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000077-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 264</span>
264:           <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">state_allows_login?</span>(<span class="ruby-identifier">state</span>)
265:             [ <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'confirmed'</span>], <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'retrieved_password'</span>] ].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">state</span>)
266:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000059" class="method-detail">
        <a name="M000059"></a>

        <div class="method-heading">
          <a href="#M000059" class="method-signature">
          <span class="method-name">states</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method returns a hash with the the available user <a
href="Core.html#M000059">states</a>. By default it returns the private
class constant DEFAULT_STATES.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000059-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000059-source">
<pre>
    <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 41</span>
41:           <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">states</span>
42:             <span class="ruby-identifier">default_states</span>
43:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000069" class="method-detail">
        <a name="M000069"></a>

        <div class="method-heading">
          <a href="#M000069" class="method-signature">
          <span class="method-name">all_groups</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method returns all groups assigned to the given user - including the
ones he gets by being assigned through group inheritance.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000069-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000069-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 176</span>
176:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">all_groups</span>
177:             <span class="ruby-identifier">result</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
178: 
179:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">group</span> <span class="ruby-keyword kw">in</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">groups</span>
180:               <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">group</span>.<span class="ruby-identifier">ancestors_and_self</span>
181:             <span class="ruby-keyword kw">end</span>
182: 
183:             <span class="ruby-identifier">result</span>.<span class="ruby-identifier">flatten!</span>
184:             <span class="ruby-identifier">result</span>.<span class="ruby-identifier">uniq!</span>
185: 
186:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">result</span>
187:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000068" class="method-detail">
        <a name="M000068"></a>

        <div class="method-heading">
          <a href="#M000068" class="method-signature">
          <span class="method-name">all_roles</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method returns all roles assigned to the given user - including the
ones he gets by being assigned a child role (i.e. the parents) and the one
he gets through his groups (inheritance is also considered) here.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000068-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000068-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 157</span>
157:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">all_roles</span>
158:             <span class="ruby-identifier">result</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
159: 
160:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">role</span> <span class="ruby-keyword kw">in</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">roles</span>
161:               <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">role</span>.<span class="ruby-identifier">ancestors_and_self</span>
162:             <span class="ruby-keyword kw">end</span>
163: 
164:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">group</span> <span class="ruby-keyword kw">in</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">groups</span>
165:               <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">group</span>.<span class="ruby-identifier">all_roles</span>
166:             <span class="ruby-keyword kw">end</span>
167: 
168:             <span class="ruby-identifier">result</span>.<span class="ruby-identifier">flatten!</span>
169:             <span class="ruby-identifier">result</span>.<span class="ruby-identifier">uniq!</span>
170: 
171:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">result</span>
172:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000071" class="method-detail">
        <a name="M000071"></a>

        <div class="method-heading">
          <a href="#M000071" class="method-signature">
          <span class="method-name">all_static_permissions</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method returns a list of all the <a
href="../../StaticPermission.html">StaticPermission</a> entities that have
been assigned to this user through his roles.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000071-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000071-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 201</span>
201:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">all_static_permissions</span>
202:             <span class="ruby-identifier">permissions</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
203: 
204:             <span class="ruby-identifier">all_roles</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">role</span><span class="ruby-operator">|</span>
205:               <span class="ruby-identifier">permissions</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">role</span>.<span class="ruby-identifier">static_permissions</span>)
206:             <span class="ruby-keyword kw">end</span>
207: 
208:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">permissions</span>
209:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000062" class="method-detail">
        <a name="M000062"></a>

        <div class="method-heading">
          <a href="#M000062" class="method-signature">
          <span class="method-name">before_create</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Set the last login time etc. when the record is created at first.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000062-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000062-source">
<pre>
    <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 68</span>
68:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">before_create</span>
69:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">last_logged_in_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
70:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000075" class="method-detail">
        <a name="M000075"></a>

        <div class="method-heading">
          <a href="#M000075" class="method-signature">
          <span class="method-name">confirm_registration</span><span class="method-args">(token)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method expects the token for the current user. If the token is
correct, the user&#8216;s state will be set to &quot;confirmed&quot; and
the associated &quot;user_registration&quot; record will be removed.
Returns &quot;true&quot; on success and &quot;false&quot; on failure/or the
user is already confirmed and/or has no &quot;user_registration&quot;
record.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000075-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000075-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 245</span>
245:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">confirm_registration</span>(<span class="ruby-identifier">token</span>)
246:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">user_registration</span>.<span class="ruby-identifier">nil?</span>
247:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">user_registration</span>.<span class="ruby-identifier">token</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">token</span>
248:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">state_transition_allowed?</span>(<span class="ruby-identifier">state</span>, <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'confirmed'</span>])
249: 
250:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">state</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'confirmed'</span>]
251:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">save!</span>
252:             <span class="ruby-identifier">user_registration</span>.<span class="ruby-identifier">destroy</span>
253: 
254:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
255:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000074" class="method-detail">
        <a name="M000074"></a>

        <div class="method-heading">
          <a href="#M000074" class="method-signature">
          <span class="method-name">create_user_registration</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method creates a <a href="Core.html#M000061">new</a> registration
token for the current user. Raises a <a
href="../../MultipleRegistrationTokens.html">MultipleRegistrationTokens</a>
Exception if the user already has a registration token assigned to him.
</p>
<p>
Use this method instead of creating user_registration objects directly!
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000074-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000074-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 233</span>
233:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_user_registration</span>
234:             <span class="ruby-identifier">raise</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">user_registration</span>.<span class="ruby-identifier">nil?</span>
235: 
236:             <span class="ruby-identifier">token</span> = <span class="ruby-constant">UserRegistration</span>.<span class="ruby-identifier">new</span>
237:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">user_registration</span> = <span class="ruby-identifier">token</span>
238:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000083" class="method-detail">
        <a name="M000083"></a>

        <div class="method-heading">
          <a href="#M000083" class="method-signature">
          <span class="method-name">did_log_in</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Sets the last login time and saves the object. Note: Must currently be
called explicitely!
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000083-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000083-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 328</span>
328:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">did_log_in</span>
329:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">last_logged_in_at</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">now</span>
330:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">execute_without_timestamps</span> { <span class="ruby-identifier">save</span> }
331:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000067" class="method-detail">
        <a name="M000067"></a>

        <div class="method-heading">
          <a href="#M000067" class="method-signature">
          <span class="method-name">encrypt_password</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method writes the attribute &quot;password&quot; to the hashed
version. It is called in the after_validation hook set by the
&quot;after_validation&quot; command above. The password is only encrypted
when no errors occured on validation, the password is <a
href="Core.html#M000061">new</a> and the password is not nil. This method
also sets the &quot;password_salt&quot; property&#8216;s value used in
User#hash_string. After encryption, the password&#8216;s &quot;<a
href="Core.html#M000061">new</a>&quot; state is reset and the confirmation
is cleared. The password hash&#8216;s type will also be set to &quot;not <a
href="Core.html#M000061">new</a>&quot; since we get problems with double
validation (as it happens when using save!) otherwise.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000067-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000067-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 136</span>
136:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">encrypt_password</span>
137:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">and</span> <span class="ruby-ivar">@new_password</span> <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">password</span>.<span class="ruby-identifier">nil?</span>
138:               <span class="ruby-comment cmt"># generate a new 10-char long hash only Base64 encoded so things are compatible</span>
139:               <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password_salt</span> = [<span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">10</span>){<span class="ruby-identifier">rand</span>(<span class="ruby-value">256</span>).<span class="ruby-identifier">chr</span>}.<span class="ruby-identifier">join</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">&quot;m&quot;</span>)[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">9</span>]; 
140: 
141:               <span class="ruby-comment cmt"># write encrypted password to object property</span>
142:               <span class="ruby-identifier">write_attribute</span>(<span class="ruby-identifier">:password</span>, <span class="ruby-identifier">hash_string</span>(<span class="ruby-identifier">password</span>))
143: 
144:               <span class="ruby-comment cmt"># mark password as &quot;not new&quot; any more</span>
145:               <span class="ruby-ivar">@new_password</span> = <span class="ruby-keyword kw">false</span>
146:               <span class="ruby-identifier">password_confirmation</span> = <span class="ruby-keyword kw">nil</span>
147:               
148:               <span class="ruby-comment cmt"># mark the hash type as &quot;not new&quot; any more</span>
149:               <span class="ruby-ivar">@new_hash_type</span> = <span class="ruby-keyword kw">false</span>
150:             <span class="ruby-keyword kw">end</span>
151:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000072" class="method-detail">
        <a name="M000072"></a>

        <div class="method-heading">
          <a href="#M000072" class="method-signature">
          <span class="method-name">has_permission?</span><span class="method-args">(*permission_titles)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method returns true if the user is granted the permission with one of
the given permission titles.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000072-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000072-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 213</span>
213:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_permission?</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">permission_titles</span>)
214:             <span class="ruby-identifier">all_roles</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">role</span><span class="ruby-operator">|</span> 
215:               <span class="ruby-identifier">role</span>.<span class="ruby-identifier">static_permissions</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">permission</span><span class="ruby-operator">|</span>
216:                 <span class="ruby-identifier">permission_titles</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">permission</span>.<span class="ruby-identifier">title</span>)
217:               <span class="ruby-keyword kw">end</span>
218:             <span class="ruby-keyword kw">end</span>
219:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000070" class="method-detail">
        <a name="M000070"></a>

        <div class="method-heading">
          <a href="#M000070" class="method-signature">
          <span class="method-name">has_role?</span><span class="method-args">(*role_titles)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method returns true if the user is assigned the role with one of the
role titles given as parameters. False otherwise.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000070-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000070-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 191</span>
191:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_role?</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">role_titles</span>)
192:             <span class="ruby-identifier">obj</span> = <span class="ruby-identifier">all_roles</span>.<span class="ruby-identifier">detect</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">role</span><span class="ruby-operator">|</span> 
193:                     <span class="ruby-identifier">role_titles</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">role</span>.<span class="ruby-identifier">title</span>)
194:                   <span class="ruby-keyword kw">end</span>
195:             
196:             <span class="ruby-keyword kw">return</span> <span class="ruby-operator">!</span><span class="ruby-identifier">obj</span>.<span class="ruby-identifier">nil?</span>
197:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000089" class="method-detail">
        <a name="M000089"></a>

        <div class="method-heading">
          <a href="#M000089" class="method-signature">
          <span class="method-name">hash_string</span><span class="method-args">(value)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Hashes the given parameter by the selected hashing method. It uses the
&quot;password_salt&quot; property&#8216;s value to make the hashing more
secure.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000089-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000089-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 431</span>
431:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">hash_string</span>(<span class="ruby-identifier">value</span>)
432:               <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">password_hash_type</span>
433:                      <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'md5'</span> <span class="ruby-keyword kw">then</span> <span class="ruby-constant">Digest</span><span class="ruby-operator">::</span><span class="ruby-constant">MD5</span>.<span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">value</span> <span class="ruby-operator">+</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password_salt</span>)
434:                      <span class="ruby-keyword kw">end</span>
435:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000073" class="method-detail">
        <a name="M000073"></a>

        <div class="method-heading">
          <a href="#M000073" class="method-signature">
          <span class="method-name">is_anonymous?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns false. <a href="Core.html#M000073">is_anonymous?</a> will only
return true on <a href="../../AnonymousUser.html">AnonymousUser</a>
objects.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000073-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000073-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 223</span>
223:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">is_anonymous?</span>
224:             <span class="ruby-keyword kw">false</span>
225:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000065" class="method-detail">
        <a name="M000065"></a>

        <div class="method-heading">
          <a href="#M000065" class="method-signature">
          <span class="method-name">new_password?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns true if the password has been set after the <a
href="../../User.html">User</a> has been loaded from the database and false
otherwise
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000065-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000065-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 102</span>
102:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">new_password?</span>
103:             <span class="ruby-ivar">@new_password</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">true</span>
104:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000064" class="method-detail">
        <a name="M000064"></a>

        <div class="method-heading">
          <a href="#M000064" class="method-signature">
          <span class="method-name">password=</span><span class="method-args">(value)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Overriding the default accessor to update @new_password on setting this
property.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000064-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000064-source">
<pre>
    <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 95</span>
95:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">password=</span>(<span class="ruby-identifier">value</span>)
96:             <span class="ruby-identifier">write_attribute</span>(<span class="ruby-identifier">:password</span>, <span class="ruby-identifier">value</span>)
97:             <span class="ruby-ivar">@new_password</span> = <span class="ruby-keyword kw">true</span>
98:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000082" class="method-detail">
        <a name="M000082"></a>

        <div class="method-heading">
          <a href="#M000082" class="method-signature">
          <span class="method-name">password_equals?</span><span class="method-args">(value)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method checks whether the given value equals the password when hashed
with this user&#8216;s password hash type. Returns a boolean.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000082-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000082-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 322</span>
322:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">password_equals?</span>(<span class="ruby-identifier">value</span>)
323:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">hash_string</span>(<span class="ruby-identifier">value</span>) <span class="ruby-operator">==</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password</span>
324:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000063" class="method-detail">
        <a name="M000063"></a>

        <div class="method-heading">
          <a href="#M000063" class="method-signature">
          <span class="method-name">password_hash_type=</span><span class="method-args">(value)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Override the accessor for the &quot;password_hash_type&quot; property so it
sets the &quot;@new_hash_type&quot; private property to signal that the
password&#8216;s hash method has been changed. Changing the password hash
type is only possible if a <a href="Core.html#M000061">new</a> password has
been provided.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000063-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000063-source">
<pre>
    <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 76</span>
76:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">password_hash_type=</span>(<span class="ruby-identifier">value</span>)
77:             <span class="ruby-identifier">write_attribute</span>(<span class="ruby-identifier">:password_hash_type</span>, <span class="ruby-identifier">value</span>)
78:             <span class="ruby-ivar">@new_hash_type</span> = <span class="ruby-keyword kw">true</span>
79:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000078" class="method-detail">
        <a name="M000078"></a>

        <div class="method-heading">
          <a href="#M000078" class="method-signature">
          <span class="method-name">state=</span><span class="method-args">(value)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Overwrite the state setting so it backs up the initial state from the
database.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000078-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000078-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 270</span>
270:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">state=</span>(<span class="ruby-identifier">value</span>)
271:             <span class="ruby-ivar">@old_state</span> = <span class="ruby-identifier">state</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_state</span>.<span class="ruby-identifier">nil?</span>
272:             <span class="ruby-identifier">write_attribute</span>(<span class="ruby-identifier">:state</span>, <span class="ruby-identifier">value</span>)
273:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000084" class="method-detail">
        <a name="M000084"></a>

        <div class="method-heading">
          <a href="#M000084" class="method-signature">
          <span class="method-name">state_transition_allowed?</span><span class="method-args">(from, to)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns true if the the state transition from &quot;from&quot; state to
&quot;to&quot; state is valid. Returns false otherwise. <tt>new_state</tt>
must be the integer value of the state as returned by
+User.states[&#8216;state_name&#8217;]+.
</p>
<p>
Note that currently no permission checking is <a
href="Core.html#M000058">included</a> here; It does not matter what
permissions the currently logged in user has, only that the state
transition is legal in principle.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000084-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000084-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 340</span>
340:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">state_transition_allowed?</span>(<span class="ruby-identifier">from</span>, <span class="ruby-identifier">to</span>)
341:             <span class="ruby-identifier">from</span> = <span class="ruby-identifier">from</span>.<span class="ruby-identifier">to_i</span>
342:             <span class="ruby-identifier">to</span> = <span class="ruby-identifier">to</span>.<span class="ruby-identifier">to_i</span>
343: 
344:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">from</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">to</span> <span class="ruby-comment cmt"># allow keeping state</span>
345: 
346:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">from</span>
347:               <span class="ruby-keyword kw">when</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'unconfirmed'</span>]
348:                 <span class="ruby-keyword kw">true</span>
349:               <span class="ruby-keyword kw">when</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'confirmed'</span>]
350:                 [ <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'retrieved_password'</span>], <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'locked'</span>], <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'deleted'</span>] ].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to</span>)
351:               <span class="ruby-keyword kw">when</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'locked'</span>]
352:                 [ <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'confirmed'</span>], <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'deleted'</span>] ].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to</span>)
353:               <span class="ruby-keyword kw">when</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'deleted'</span>]
354:                 [ <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'confirmed'</span>] ].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to</span>)
355:               <span class="ruby-keyword kw">when</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'retrieved_password'</span>]
356:                 [ <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'confirmed'</span>], <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'locked'</span>], <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>[<span class="ruby-value str">'deleted'</span>] ].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">to</span>)
357:               <span class="ruby-keyword kw">when</span> <span class="ruby-value">0</span>
358:                 <span class="ruby-constant">User</span>.<span class="ruby-identifier">states</span>.<span class="ruby-identifier">value?</span>(<span class="ruby-identifier">to</span>)
359:               <span class="ruby-keyword kw">else</span>
360:                 <span class="ruby-keyword kw">false</span>
361:             <span class="ruby-keyword kw">end</span>
362:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000066" class="method-detail">
        <a name="M000066"></a>

        <div class="method-heading">
          <a href="#M000066" class="method-signature">
          <span class="method-name">update_password</span><span class="method-args">(pass)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Method to update the password and confirmation at the same time. Call this
method when you update the password from code and don&#8216;t need
password_confirmation - which should really only be used when data comes
from forms.
</p>
<p>
A ussage example:
</p>
<pre>
  user = User.find(1)
  user.update_password &quot;n1C3s3cUreP4sSw0rD&quot;
  user.save
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000066-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000066-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 117</span>
117:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_password</span>(<span class="ruby-identifier">pass</span>)
118:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password_confirmation</span> = <span class="ruby-identifier">pass</span>
119:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">password</span> = <span class="ruby-identifier">pass</span>
120:           <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000086" class="method-detail">
        <a name="M000086"></a>

        <div class="method-heading">
          <a href="#M000086" class="method-signature">
          <span class="method-name">validate</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Overriding this method to do some more validation: Password equals
password_confirmation, state an password hash type being in the range of
allowed values.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000086-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000086-source">
<pre>
     <span class="ruby-comment cmt"># File /home/yossarian/aptana_workspace/imcalendar/config/../vendor/plugins/active_rbac/lib/active_rbac_mixins/user_mixins.rb, line 390</span>
390:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">validate</span>
391:               <span class="ruby-comment cmt"># validate state and password has type to be in the valid range of values</span>
392:               <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">:password_hash_type</span>, <span class="ruby-value str">&quot;must be in the list of hash types.&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">password_hash_types</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">password_hash_type</span>
393:               <span class="ruby-comment cmt"># check that the state transition is valid</span>
394:               <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">:state</span>, <span class="ruby-value str">&quot;must be a valid new state from the current state.&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">state_transition_allowed?</span>(<span class="ruby-ivar">@old_state</span>, <span class="ruby-identifier">state</span>)
395: 
396:               <span class="ruby-comment cmt"># validate the password</span>
397:               <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@new_password</span> <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">password</span>.<span class="ruby-identifier">nil?</span>
398:                 <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">:password</span>, <span class="ruby-value str">'must match the confirmation.'</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">password_confirmation</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">password</span>
399:               <span class="ruby-keyword kw">end</span>
400: 
401:               <span class="ruby-comment cmt"># check that the password hash type has not been set if no new password</span>
402:               <span class="ruby-comment cmt"># has been provided</span>
403:               <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@new_hash_type</span> <span class="ruby-keyword kw">and</span> (<span class="ruby-operator">!</span><span class="ruby-ivar">@new_password</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">password</span>.<span class="ruby-identifier">nil?</span>) <span class="ruby-keyword kw">then</span>
404:                 <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">:password_hash_type</span>, <span class="ruby-value str">'cannot be changed unless a new password has been provided.'</span>)
405:               <span class="ruby-keyword kw">end</span>
406:             <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>